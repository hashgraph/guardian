<div class="context">
    <form *ngIf="started" [formGroup]="dataForm" class="context">
        <div class="configurator-block-title">Schema Properties</div>
        <div class="input-field-container guardian-input-container">
            <label class="form-label" htmlFor="schemaName">* Schema Name</label>
            <input
                formControlName="name"
                id="schemaName"
                pInputText
                placeholder="Schema Name"
                type="text"
            />
        </div>

        <div class="optional-row">
            <div *ngIf="isPolicy" class="dropdown-field guardian-input-container">
                <label class="form-label" htmlFor="policy">* Policy</label>
                <p-dropdown
                    class="guardian-dropdown"
                    panelStyleClass="guardian-dropdown-panel width-825"
                    (onChange)="onFilter($event)"
                    [options]="policies"
                    [attr.disabled-dropdown]="!isNewSchema"
                    appendTo="body"
                    formControlName="topicId"
                    id="policy"
                    optionLabel="name"
                    optionValue="topicId"
                    placeholder="Policy"
                ></p-dropdown>
            </div>

            <div *ngIf="isTool" class="dropdown-field guardian-input-container">
                <label class="form-label" htmlFor="tools">* Tool</label>
                <p-dropdown
                    class="guardian-dropdown"
                    panelStyleClass="guardian-dropdown-panel width-825"
                    [options]="tools"
                    appendTo="body"
                    formControlName="topicId"
                    id="tools"
                    optionLabel="name"
                    optionValue="topicId"
                    placeholder="No binding"
                    [attr.disabled-dropdown]="!isNewSchema"
                ></p-dropdown>
            </div>

            <div *ngIf="isSystem" class="dropdown-field guardian-input-container">
                <label class="form-label" htmlFor="forSystemEntity">For (Entity)</label>
                <p-dropdown
                    class="guardian-dropdown"
                    panelStyleClass="guardian-dropdown-panel"
                    [options]="systemEntityOptions"
                    appendTo="body"
                    formControlName="entity"
                    id="forSystemEntity"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Entity"
                ></p-dropdown>
            </div>

            <div *ngIf="isPolicy || isModule" class="dropdown-field guardian-input-container">
                <label class="form-label" htmlFor="forPolicyModuleEntity">For (Entity)</label>
                <p-dropdown
                    class="guardian-dropdown"
                    panelStyleClass="guardian-dropdown-panel"
                    [options]="policyModuleEntityOptions"
                    appendTo="body"
                    formControlName="entity"
                    id="forPolicyModuleEntity"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Entity"
                ></p-dropdown>
            </div>
        </div>

        <div class="guardian-input-container input-field-container" style="margin-bottom: 32px">
            <label class="form-label" htmlFor="descriptionForSchema">Description</label>
            <input
                formControlName="description"
                id="descriptionForSchema"
                pInputText
                placeholder="Description for Schema (optional)"
                type="text"
            />
        </div>

        <ng-container *ngIf="defaultFieldsMap[currentEntity]; let fields">
            <div class="configurator-block-title">System Fields</div>
            <div class="fields">
                <div class="custom-fields">
                    <div *ngFor="let field of fields" class="custom-schema-field">
                        <schema-field-configuration
                            [extended]="extended"
                            [readonly]="true"
                            [value]="field"
                            [errors]="errors"
                        >
                        </schema-field-configuration>
                    </div>
                </div>
            </div>
        </ng-container>

        <div class="configurator-block-title">Fields</div>

        <div *ngIf="fields && fields.length" class="fields">
            <div (cdkDropListDropped)="drop($event)"
                 [cdkDropListData]="fields"
                 cdkDropList
                 class="custom-fields"
            >
                <div *ngFor="let field of fields" class="custom-schema-field">
                    <schema-field-configuration
                        (remove)="onRemove(field)"
                        [extended]="extended"
                        [types]="types"
                        [field]="field"
                        [form]="dataForm"
                        [fieldsForm]="fieldsForm"
                        [measureTypes]="measureTypes"
                        [private]="dataForm.value?.entity === 'EVC'"
                        [properties]="properties"
                        [schemaTypes]="schemaTypes"
                        [schemaTypeMap]="schemaTypeMap"
                        [errors]="errors"
                        [buildField]="buildField"
                    >
                    </schema-field-configuration>
                </div>
            </div>
        </div>

        <button 
            (click)="onAdd($event)" 
            class="guardian-button guardian-button-secondary add-btn">
            <div class="guardian-button-icon">
                <svg-icon 
                    class="icon-btn svg-icon" 
                    src="/assets/images/icons/add.svg"
                    svgClass="icon-color-primary">
                </svg-icon>
            </div>
            <div class="guardian-button-label">Add Field</div>
        </button>

        <div class="configurator-block-title">Conditions</div>

        <ng-template [ngIf]="fields && fields.length > 0">
            <div
                *ngIf="conditions && conditions.length"
                class="conditions-container"
            >
                <div *ngFor="let condition of conditions">
                    <div class="condition-item">
                        <div class="condition-item">
                            <div class="condition-if-container">
                                <div class="if-mode-dropdown guardian-input-container" style="min-width: 180px;">
                                    <p-dropdown
                                        class="guardian-dropdown"
                                        panelStyleClass="guardian-dropdown-panel"
                                        [options]="ifModeOptions"
                                        [formControl]="getOperatorControl(condition)"
                                        appendTo="body"
                                        placeholder="IF mode"
                                        (onChange)="onIfModeChange(condition)">
                                    </p-dropdown>
                                </div>
                                <ng-container [ngSwitch]="getOperatorValue(condition)">
                                    <div *ngSwitchCase="'SINGLE'" class="if-label-mode">
                                        <span class="condition-label if-text-mode">IF</span>
                                    </div>

                                    <div *ngSwitchCase="'AND'" class="if-label-mode">
                                        <span class="condition-label if-text-mode">IF ALL</span><span>of the rules
                                            match</span>
                                    </div>
                                    <div *ngSwitchCase="'OR'" class="if-label-mode">
                                        <span class="condition-label if-text-mode">IF ANY</span><span> rules
                                            match</span>

                                    </div>
                                </ng-container>

                                <div class="if-rows">
                                    <div class="if-condition-equality-container"
                                        *ngFor="let row of getIfRows(condition); let i = index">
                                        <div class="if-dropdown-field guardian-input-container">
                                            <label class="form-label">* Field</label>
                                            <p-dropdown
                                                class="guardian-dropdown"
                                                panelStyleClass="guardian-dropdown-panel"
                                                [options]="getFieldsForCondition(condition)"
                                                appendTo="body"
                                                optionLabel="controlDescription.value"
                                                placeholder="Field"
                                                [formControl]="getRowFieldControl(row)"
                                                (onChange)="onIfRowFieldChange(condition, i, $event)">
                                            </p-dropdown>
                                        </div>

                                        <div *ngIf="getRowField(row)" class="equal-label">=</div>


                                        <ng-container [ngSwitch]="true">
                                            <div
                                                *ngSwitchCase="isFieldType1(getRowField(row))"
                                                class="input-field-container guardian-input-container"
                                                style="margin-bottom: unset"
                                            >
                                                <label class="form-label">Field value</label>
                                                <input
                                                    [formControl]="getRowValueControl(row)"
                                                    pInputText
                                                    placeholder="Field value"
                                                    type="text"
                                                />
                                            </div>

                                            <div
                                                *ngSwitchCase="isFieldType2(getRowField(row))"
                                                class="input-field-container guardian-input-container"
                                                style="margin-bottom: unset"
                                            >
                                                <label class="form-label">* Field value</label>
                                                <input
                                                    [formControl]="getRowValueControl(row)"
                                                    pInputText
                                                    placeholder="Field value"
                                                    step="1"
                                                    type="time"
                                                />
                                            </div>

                                            <div *ngSwitchCase="isFieldType3(getRowField(row))"
                                                class="form-group required-form-field guardian-input-container">
                                                <label class="form-label">Choose a date &amp; time</label>
                                                <p-calendar
                                                    class="guardian-datepicker"
                                                    [formControl]="getRowValueControl(row)"
                                                    [showTime]="true"
                                                    [hourFormat]="'12'"
                                                    appendTo="body"></p-calendar>
                                            </div>

                                            <div *ngSwitchCase="isFieldType4(getRowField(row))"
                                                class="form-group example-full-width required-form-field">
                                                <label class="form-label">Choose a date</label>
                                                <p-calendar
                                                    class="guardian-datepicker"
                                                    [formControl]="getRowValueControl(row)"
                                                    [showTime]="false"
                                                    appendTo="body"></p-calendar>
                                            </div>

                                            <div *ngSwitchCase="isFieldType5(getRowField(row))"
                                                class="radio-button-container">
                                                <div>
                                                    <p-radioButton
                                                        [name]="'booleanOption' + condition.name + i"
                                                        [value]="true"
                                                        [formControl]="getRowValueControl(row)"
                                                        class="guardian-radio-button boolean-option"
                                                        label="True">
                                                    </p-radioButton>
                                                </div>
                                                <div>
                                                    <p-radioButton
                                                        [name]="'booleanOption' + condition.name + i"
                                                        [value]="false"
                                                        [formControl]="getRowValueControl(row)"
                                                        class="guardian-radio-button boolean-option"
                                                        label="False">
                                                    </p-radioButton>
                                                </div>
                                            </div>
                                        </ng-container>
                                        <button
                                            *ngIf="getOperatorValue(condition) !== 'SINGLE' && getIfRows(condition).length > 1"
                                            (click)="onIfRowRemove(condition, i)"
                                            class="guardian-icon-button guardian-button-delete rmv-condition-btn">
                                            <div class="guardian-button-icon">
                                                <svg-icon class="icon-btn svg-icon"
                                                    src="/assets/images/icons/delete.svg" svgClass="icon-color-delete">
                                                </svg-icon>
                                            </div>
                                        </button>
                                    </div>

                                    <button *ngIf="getOperatorValue(condition) !== 'SINGLE'"
                                        (click)="onIfRowAdd(condition)"
                                        class="guardian-button guardian-button-secondary add-rule-btn">
                                        <div class="guardian-button-label">Add rule</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <p class="condition-label">THEN</p>
                        <div
                            *ngIf="condition.thenControls"
                            class="condition-container"
                        >
                            <div
                                (cdkDropListDropped)="drop($event)"
                                [cdkDropListAutoScrollDisabled]
                                [cdkDropListData]="condition.thenControls"
                                cdkDropList
                                class="custom-fields"
                            >
                                <div *ngFor="let conditionField of condition.thenControls" class="custom-schema-field">
                                    <schema-field-configuration
                                        (remove)="onConditionFieldRemove(condition,conditionField,'then')"
                                        [field]="conditionField"
                                        [types]="types"
                                        [form]="dataForm"
                                        [fieldsForm]="conditionsForm.get(condition.name)?.get('thenFieldControls')"
                                        [measureTypes]="measureTypes"
                                        [properties]="properties"
                                        [extended]="extended"
                                        [schemaTypes]="schemaTypes"
                                        [schemaTypeMap]="schemaTypeMap"
                                        [errors]="errors"
                                        [buildField]="buildField"
                                    >
                                    </schema-field-configuration>
                                </div>
                            </div>
                        </div>

                        <button 
                            (click)="onConditionFieldAdd(condition, 'then')"
                            class="guardian-button guardian-button-secondary add-btn">
                            <div class="guardian-button-icon">
                                <svg-icon 
                                    class="icon-btn svg-icon" 
                                    src="/assets/images/icons/add.svg"
                                    svgClass="icon-color-primary">
                                </svg-icon>
                            </div>
                            <div class="guardian-button-label">Add THEN Field</div>
                        </button>

                        <p class="condition-label">ELSE</p>
                        <div
                            *ngIf="condition.elseControls"
                            class="condition-container"
                        >
                            <div
                                (cdkDropListDropped)="drop($event)"
                                [cdkDropListAutoScrollDisabled]
                                [cdkDropListData]="condition.elseControls"
                                cdkDropList
                                class="custom-fields"
                            >
                                <div *ngFor="let conditionField of condition.elseControls" class="custom-schema-field">
                                    <schema-field-configuration
                                        (remove)="onConditionFieldRemove(condition,conditionField,'else')"
                                        [field]="conditionField"
                                        [types]="types"
                                        [form]="dataForm"
                                        [fieldsForm]="conditionsForm.get(condition.name)?.get('elseFieldControls')"
                                        [measureTypes]="measureTypes"
                                        [properties]="properties"
                                        [extended]="extended"
                                        [schemaTypes]="schemaTypes"
                                        [schemaTypeMap]="schemaTypeMap"
                                        [errors]="errors"
                                        [buildField]="buildField"
                                    >
                                    </schema-field-configuration>
                                </div>
                            </div>
                        </div>

                        <button 
                            (click)="onConditionFieldAdd(condition, 'else')"
                            class="guardian-button guardian-button-secondary add-btn">
                            <div class="guardian-button-icon">
                                <svg-icon 
                                    class="icon-btn svg-icon" 
                                    src="/assets/images/icons/add.svg"
                                    svgClass="icon-color-primary">
                                </svg-icon>
                            </div>
                            <div class="guardian-button-label">Add ELSE Field</div>
                        </button>

                        <button 
                            (click)="onConditionRemove(condition)"
                            class="guardian-button guardian-button-delete rmv-btn">
                            <div class="guardian-button-icon">
                                <svg-icon 
                                    class="icon-btn svg-icon" 
                                    src="/assets/images/icons/delete.svg"
                                    svgClass="icon-color-delete">
                                </svg-icon>
                            </div>
                            <div class="guardian-button-label">Remove Condition</div>
                        </button>
                    </div>
                </div>
            </div>

            <button 
                (click)="onConditionAdd()"
                class="guardian-button guardian-button-secondary add-btn">
                <div class="guardian-button-icon">
                    <svg-icon 
                        class="icon-btn svg-icon" 
                        src="/assets/images/icons/add.svg"
                        svgClass="icon-color-primary">
                    </svg-icon>
                </div>
                <div class="guardian-button-label">Add Condition</div>
            </button>
        </ng-template>

        <ng-template [ngIf]="fields.length == 0">
            <div class="no-conditions-label">To add Conditions first you need to add field</div>
        </ng-template>
    </form>
</div>
