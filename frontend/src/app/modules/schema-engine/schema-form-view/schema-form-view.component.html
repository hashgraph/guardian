<form>
    <ng-container *ngFor="let item of fields">

        <div *ngIf="ifFieldVisible(item)" class="form-field-container" [attr.field-id]="item.fullPath">

            <!-- simple field -->
            <div *ngIf="ifSimpleField(item)" class="form-field">
                <div class="label-field">{{item.description}}</div>

                <div *ngIf="item.isInvalidType" class="invalid-type">
                    <b>The field type does not match the field type in the schema</b>
                </div>

                <div *ngIf="!item.isInvalidType" class="form-field-value" [attr.rules-status]="isRulesStatus(item)">
                    <div class="form-field-prefix" *ngIf="isPrefix(item)">{{item.unit}}</div>

                    <div *ngIf="item.customType === 'table'" class="form-field-table">
                        <table-viewer
                                [value]="item.value"
                                [title]="item.title || item.description || item.name"
                        ></table-viewer>
                    </div>

                    <div *ngIf="isInput(item) && !isIPFS(item)" class="form-field-input guardian-input-container">
                        <input
                            pInputText
                            [value]="item.value"
                            [readonly]="true"
                            type="text"/>
                    </div>

                    <div *ngIf="isInput(item) && isIPFS(item)" class="form-field-ipfs guardian-input-container">
                        <div class="form-field-url">
                            <input
                                pInputText
                                [value]="item.value"
                                [readonly]="true"
                                type="text"/>
                            <div class="form-field-url-buttons">
                                <button 
                                    [cdkCopyToClipboard]="item.value" 
                                    class="guardian-button guardian-button-primary">Copy Link</button>
                                <button
                                    [cdkCopyToClipboard]="getCID(item.value)"
                                    class="guardian-button guardian-button-secondary">Copy CID</button>
                            </div>
                        </div>

                        <div *ngIf="item?.customType !== 'file'" class="form-field-img">
                            <img *ngIf="!item.loading; else loading" class="ipfs-image" [src]="item.imgSrc" [alt]="item.value">
                            <ng-template #loading>
                                <div class="guardian-loading">
                                    <div class="guardian-loading-image"></div>
                                </div>
                            </ng-template>
                        </div>
                    </div>

                    <div *ngIf="isTime(item)" class="form-field-input guardian-input-container">
                        <input [readonly]="true" [value]="item.value" class="p-field-input" pInputText>
                    </div>

                    <div *ngIf="isDateTime(item)" class="form-field-input guardian-input-container">
                        <input [readonly]="true" [value]="item.value | date: 'medium'" class="p-field-input" pInputText>
                    </div>

                    <div *ngIf="isDate(item)" class="form-field-input guardian-input-container">
                        <input [readonly]="true" [value]="item.value" class="p-field-input" pInputText>
                    </div>

                    <div *ngIf="isBoolean(item)" class="form-field-boolean">
                        <span class="boolean-show">{{ isBooleanView(item.value) }}</span>
                    </div>

                    <div class="form-field-postfix" *ngIf="isPostfix(item)">{{item.unit}}</div>

                    <div
                        *ngIf="isFormulas(item) as formulas"
                        class="form-field-formula">
                        <button
                            class="guardian-icon-button guardian-icon-button-secondary"
                            (click)="showFormulas(formulas)">
                            <svg-icon
                                src="/assets/images/icons/function.svg"
                                svgClass="icon-color-primary"></svg-icon>
                        </button>
                    </div>

                    <ng-container *ngIf="isDiscussion(item)">
                        <div
                            *ngIf="isDiscussionCount(item) as messageCount; else elseDiscussion"
                            class="form-field-discussion">
                            <button
                                class="guardian-icon-button"
                                (click)="openDiscussion(item)">
                                <svg-icon
                                    src="/assets/images/icons/chat.svg"
                                    svgClass="icon-color-grey-color-3"
                                ></svg-icon>
                            </button>
                            <div class="icon-count">{{messageCount}}</div>
                        </div>
                        <ng-template #elseDiscussion>
                            <div class="form-field-discussion">
                                <button
                                    class="guardian-icon-button"
                                    (click)="openDiscussion(item)">
                                    <svg-icon
                                        src="/assets/images/icons/chat.svg"
                                        svgClass="icon-color-grey-color-3"
                                    ></svg-icon>
                                </button>
                            </div>
                        </ng-template>
                    </ng-container>

                    <div
                        *ngIf="discussionAction"
                        class="form-field-discussion discussion-action">
                        <button
                            class="guardian-icon-button"
                            (click)="linkMessage(item)">
                            <svg-icon
                                src="/assets/images/icons/hashtag.svg"
                                svgClass="icon-color-primary"></svg-icon>
                        </button>
                    </div>

                    <div
                        *ngIf="isRules(item) as rule"
                        class="form-field-rule"
                        [pTooltip]="rule.tooltip"
                        tooltipPosition="top"
                        [showDelay]="1000">
                        <svg-icon
                                *ngIf="rule.status === 'Failure' || rule.status === 'Error'"
                                src="/assets/images/icons/warning-2.svg"
                                svgClass="icon-color-warning"></svg-icon>
                        <svg-icon
                                *ngIf="rule.status === 'Success'"
                                src="/assets/images/icons/check.svg"
                                svgClass="icon-color-success"></svg-icon>
                    </div>
                </div>
            </div>

            <!-- array of simple fields -->
            <div *ngIf="ifSimpleArray(item)" class="form-field-array">
                <div class="label-field">{{item.description}}</div>

                <div *ngIf="item.isInvalidType" class="invalid-type">
                    <b>The field type does not match the field type in the schema</b>
                </div>

                <div
                    *ngFor="let listItem of getItemsPage(item)"
                    class="form-field-array-item-container"
                    [attr.index]="item.list.indexOf(listItem)"
                >
                    <div class="form-field-array-item">

                        <div class="form-field-value">
                            <div class="form-field-prefix" *ngIf="isPrefix(item)">{{item.unit}}</div>

                            <div *ngIf="item.customType === 'table'" class="form-field-table">
                                <table-viewer
                                        [value]="listItem.value"
                                        [title]="item.title || item.description || item.name"
                                ></table-viewer>
                            </div>

                            <div *ngIf="isInput(item) && !isIPFS(item)" class="form-field-input guardian-input-container">
                                <input
                                    pInputText
                                    [value]="listItem.value"
                                    [readonly]="true"
                                    type="text"/>
                            </div>

                            <div *ngIf="isInput(item) && isIPFS(item)" class="form-field-ipfs guardian-input-container">
                                <div class="form-field-url">
                                    <input
                                        pInputText
                                        [value]="listItem.value"
                                        [readonly]="true"
                                        type="text"/>
                                    <div class="form-field-url-buttons">
                                        <button
                                                [cdkCopyToClipboard]="listItem.value"
                                            class="guardian-button guardian-button-primary">Copy Link</button>
                                        <button
                                                [cdkCopyToClipboard]="getCID(listItem.value)"
                                            class="guardian-button guardian-button-secondary">Copy CID</button>
                                    </div>
                                </div>
                                <div class="form-field-img">
                                    <img *ngIf="!listItem.loading; else loading" class="ipfs-image" [src]="listItem.imgSrc" [alt]="listItem.value">
                                    <ng-template #loading>
                                        <div class="guardian-loading">
                                            <div class="guardian-loading-image"></div>
                                        </div>
                                    </ng-template>
                                </div>
                            </div>

                            <div *ngIf="isTime(item)" class="form-field-input guardian-input-container">
                                <input [readonly]="true" [value]="listItem.value" class="p-field-input" pInputText>
                            </div>

                            <div *ngIf="isDateTime(item)" class="form-field-input guardian-input-container">
                                <input [readonly]="true" [value]="listItem.value | date: 'medium'" class="p-field-input" pInputText>
                            </div>

                            <div *ngIf="isDate(item)" class="form-field-input guardian-input-container">
                                <input [readonly]="true" [value]="listItem.value" class="p-field-input" pInputText>
                            </div>

                            <div *ngIf="isBoolean(item)" class="boolean-form-field">
                                <span class="boolean-show">{{ isBooleanView(listItem.value) }}</span>
                            </div>

                            <div class="form-field-postfix" *ngIf="isPostfix(item)">{{item.unit}}</div>
                        </div>
                    </div>
                </div>
                <app-paginator
                    *ngIf="item.pageSize < item.count"
                    class="guardian-grid-paginator"
                    [pageIndex]="item.pageIndex"
                    [pageSize]="item.pageSize"
                    [length]="item.count"
                    (page)="onPage(item, $event)"
                ></app-paginator>
            </div>

            <div *ngIf="ifSubSchema(item)" class="form-field-group">
                <p-accordion class="guardian-accordion">
                    <p-accordionTab [(selected)]="item.open">
                        <ng-template pTemplate="header">
                            <div class="label-field-accordion">{{item.description}}</div>
                        </ng-template>
                        <ng-container *ngIf="item.open">
                            <div *ngIf="this.values && this.values[item.name]" class="form-field-array-item">
                                <div class="form-field-group">
                                    <ng-container [ngSwitch]="item.customType">
                                        <app-geojson-type
                                            *ngSwitchCase="'geo'"
                                            [preset]="this.values && this.values[item.name]"
                                            [disabled]="true">
                                        </app-geojson-type>
                                        <app-sentinel-hub-type
                                            *ngSwitchCase="'sentinel'"
                                            [disabled]="true"
                                            [preset]="this.values && this.values[item.name]">
                                        </app-sentinel-hub-type>
                                        <app-schema-form-view
                                            *ngSwitchDefault
                                            [dryRun]="dryRun"
                                            [private-fields]="hide"
                                            [delimiter-hide]="true"
                                            [fields]="item.fields"
                                            [values]="this.values && this.values[item.name]"
                                            [rules]="rules"
                                            [formulas]="formulas"
                                            [link]="item.link"
                                            [discussion]="discussionData"
                                            [discussion-view]="discussionView"
                                            [discussion-action]="discussionAction"
                                            (discussion-action)="onDiscussionAction($event)">
                                        </app-schema-form-view>
                                    </ng-container>
                                </div>
                            </div>
                        </ng-container>
                    </p-accordionTab>
                </p-accordion>
            </div>

            <div *ngIf="ifSubSchemaArray(item)" class="form-field-group schema-form-field-array-group">
                <p-accordion class="guardian-accordion">
                    <p-accordionTab [(selected)]="item.open">
                        <ng-template pTemplate="header">
                            <div class="label-field-accordion">{{item.description}}</div>
                        </ng-template>
                        <ng-container *ngIf="item.open">
                            <div
                                *ngFor="let listItem of getItemsPage(item)"
                                class="form-field-array-item short-delimiter"
                                [attr.index]="item.list.indexOf(listItem)">
                                <div class="form-field-group">
                                    <ng-container [ngSwitch]="item.customType">
                                        <app-geojson-type
                                            *ngSwitchCase="'geo'"
                                            [preset]="listItem"
                                            [disabled]="true">
                                        </app-geojson-type>
                                        <app-sentinel-hub-type
                                            *ngSwitchCase="'sentinel'"
                                            [disabled]="true"
                                            [preset]="listItem">
                                        </app-sentinel-hub-type>
                                        <app-schema-form-view
                                            *ngSwitchDefault
                                            [delimiter-hide]="true"
                                            [private-fields]="hide"
                                            [dryRun]="dryRun"
                                            [fields]="item.fields"
                                            [values]="listItem"
                                            [rules]="rules"
                                            [formulas]="formulas"
                                            [link]="item.link"
                                            [discussion]="discussionData"
                                            [discussion-view]="discussionView"
                                            [discussion-action]="discussionAction"
                                            (discussion-action)="onDiscussionAction($event)">
                                        </app-schema-form-view>
                                    </ng-container>
                                </div>
                                <!-- <div class="short-delimiter-container">
                                    <div class="delimiter"></div>
                                </div> -->
                            </div>
                            <app-paginator
                                *ngIf="item.pageSize < item.count"
                                class="guardian-grid-paginator"
                                [pageIndex]="item.pageIndex"
                                [pageSize]="item.pageSize"
                                [length]="item.count"
                                (page)="onPage(item, $event)"
                            ></app-paginator>
                        </ng-container>
                    </p-accordionTab>
                </p-accordion>
            </div>

        </div>

        <div *ngIf="!delimiterHide" class="delimiter"></div>

    </ng-container>
</form>
