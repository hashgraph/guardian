<div class="container">
    <ng-container
        *ngIf="loading && taskId"
        [ngTemplateOutlet]="taskExecution"
    ></ng-container>
    <ng-container *ngIf="!loading && isConfirmed">
        <ng-container [ngTemplateOutlet]="header"></ng-container>
        <ng-container
            *ngIf="profile"
            [ngTemplateOutlet]="userInfo"
        ></ng-container>
    </ng-container>
    <ng-container
        *ngIf="!loading && !isConfirmed"
        [ngTemplateOutlet]="registerDID"
    ></ng-container>
    <div *ngIf="loading && !taskId" class="loading">
        <div class="preloader-image preloader-image-l-size"></div>
    </div>
</div>

<ng-template #header>
    <div class="header">
        <h1>Profile</h1>
    </div>
</ng-template>

<ng-template #userInfo>
    <div class="tabs-nav">
        <p-tabView [(activeIndex)]="tabIndex" (onChange)="onChangeTab($event)" class="guardian-header-tabs">
            <p-tabPanel [selected]="tab === 'general'">
                <ng-template pTemplate="header">
                    <div class="tabview-label">General</div>
                </ng-template>
            </p-tabPanel>
            <p-tabPanel [selected]="tab === 'wallets'">
                <ng-template pTemplate="header">
                    <div class="tabview-label">Wallets</div>
                </ng-template>
            </p-tabPanel>
        </p-tabView>
    </div>
    <ng-container *ngIf="tab === 'general'">
        <div class="user-info-container">
            <div class="item-header">Account</div>
            <div class="item">
                <span>User Name</span>
                <span class="value-text">{{ profile!.username }}</span>
            </div>
            <div class="item">
                <span>Password</span>
                <div (click)="changePassword(profile)" class="view-document-button">
                    <span>Change Password</span>
                </div>
            </div>


            <div class="item-header">Hedera</div>
            <div class="item">
                <span>Hedera Account ID</span>
                <div>
                    <hedera-explorer [params]="profile!.hederaAccountId || ''" type="accounts">
                        {{ profile!.hederaAccountId }}
                    </hedera-explorer>
                </div>
            </div>
            <div *ngIf="profile!.topicId" class="item">
                <span>User Topic</span>
                <div>
                    <hedera-explorer [params]="profile!.topicId" type="topics">
                        {{ profile!.topicId }}
                    </hedera-explorer>
                </div>
            </div>
            <div *ngIf="profile!.parentTopicId" class="item">
                <span>Initialization Topic</span>
                <div>
                    <hedera-explorer [params]="profile!.parentTopicId" type="topics">
                        {{ profile!.parentTopicId }}
                    </hedera-explorer>
                </div>
            </div>
            <div class="item">
                <span>Balance</span>
                <span class="value-text">{{ balance }}</span>
            </div>


            <div class="item-header">Documents</div>
            <div class="item">
                <span>DID</span>
                <span class="value-text">{{ profile!.did }}</span>
            </div>
            <div class="item">
                <span>DID Document</span>
                <div (click)="openDIDDocument(profile!.didDocument, 'DID Document')" class="view-document-button">
                    <svg-icon class="svg-icon-16" src="/assets/images/icons/16/file.svg"
                            svgClass="primary-color"></svg-icon>
                    <span>View document</span>
                </div>
            </div>
            <div class="item">
                <span>VC Document</span>
                <div (click)="openVCDocument(profile!.vcDocument, 'VC Document')" class="view-document-button">
                    <svg-icon class="svg-icon-16" src="/assets/images/icons/16/file.svg"
                            svgClass="primary-color"></svg-icon>
                    <span>View document</span>
                </div>
            </div>
        </div>
    </ng-container>
    <ng-container *ngIf="tab === 'wallets'">
        <div class="guardian-user-page-toolbar">
            <div class="guardian-user-page-filters">
                <div class="search-filter">
                    <input
                        [(ngModel)]="searchWallet"
                        class="guardian-input search-policy-input"
                        pInputText
                        placeholder="Search by keyword"
                        type="text" 
                        (change)="onSetWalletSearch()"/>
                    <i class="search-icon">
                        <svg-icon 
                            class="svg-icon-16" 
                            src="/assets/images/icons/16/search.svg" 
                            svgClass="icon-color-close">
                        </svg-icon>
                    </i>
                </div>
            </div>
            <div class="guardian-user-page-buttons">
                <button
                    (click)="onCreateWallet()"
                    class="guardian-button guardian-button-primary">
                    <div class="guardian-button-icon">
                        <svg-icon
                            class="icon-btn"
                            src="/assets/images/icons/add.svg"
                            svgClass="icon-color-secondary">
                        </svg-icon>
                    </div>
                    <div class="guardian-button-label">Add Wallet</div>
                </button>
            </div>
        </div>
        <div class="guardian-user-page-grid">
            <ng-container *ngIf="walletPage && walletPage.length > 0; else noData">
                <div class="guardian-grid-container">
                    <p-table
                        class="guardian-grid-table"
                        [value]="walletPage"
                        [scrollable]="true"
                    >
                        <ng-template pTemplate="header">
                            <tr class="guardian-grid-header">
                                <ng-container *ngFor="let column of walletColumns">
                                    <th
                                        *ngIf="!column.canDisplay || column.canDisplay()"
                                        class="header-cell-{{column.type}} col-{{column.size}}"
                                        [ngSwitch]="column.id"
                                    >
                                        <ng-container *ngSwitchCase="'balance'">
                                            <div class="balance-header">
                                                <div class="balance-container">
                                                        {{column.title}}
                                                </div>
                                                <div 
                                                    class="guardian-icon-button big balance-button" 
                                                    (click)="updateAllBalance()">
                                                    <svg-icon 
                                                        class="svg-icon-16"
                                                        src="/assets/images/icons/16/refresh.svg"
                                                        [svgClass]="'icon-color-primary'">
                                                    </svg-icon>
                                                </div>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchDefault>
                                            {{column.title}}
                                        </ng-container>
                                    </th>
                                </ng-container>
                            </tr>
                        </ng-template>
                        <ng-template let-row pTemplate="body">
                            <tr class="guardian-grid-row">
                                <ng-container *ngFor="let column of walletColumns">
                                    <td
                                        *ngIf="!column.canDisplay || column.canDisplay()"
                                        class="row-cell-{{column.type}} col-{{column.size}}"
                                        pTooltip="{{row[column.id]}}"
                                        [tooltipDisabled]="!column.tooltip"
                                        tooltipPosition="top"
                                        [showDelay]="1000"
                                        [ngSwitch]="column.id"
                                    >
                                        <ng-container *ngSwitchCase="'balance'">
                                            <div class="balance-cell">
                                                <div *ngIf="row.__loading" class="balance-container">
                                                    <div class="balance-loading"></div>
                                                </div>
                                                <div *ngIf="!row.__loading" class="balance-container">
                                                    {{getBalance(row)}}
                                                </div>
                                                <div 
                                                    class="guardian-icon-button big balance-button" 
                                                    (click)="updateBalance(row)">
                                                    <svg-icon 
                                                        class="svg-icon-16"
                                                        src="/assets/images/icons/16/refresh.svg"
                                                        [svgClass]="'icon-color-primary'">
                                                    </svg-icon>
                                                </div>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'account'">
                                            <hedera-explorer [params]="row[column.id] || ''" type="accounts">
                                                {{ row[column.id] }}
                                            </hedera-explorer>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'options'">
                                            <button
                                                (click)="onOpenWallet(row)"
                                                class="guardian-button guardian-button-secondary grid-btn"
                                            >Details</button>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'delete'">
                                            <div
                                                [attr.disabled]="row.status === 'PUBLISHED'"
                                                class="guardian-icon-button big"
                                                (click)="onDeleteWallet(row)">
                                                <svg-icon
                                                    class="icon-btn"
                                                    src="/assets/images/icons/delete.svg"
                                                    [svgClass]="row.status === 'PUBLISHED' ? 'icon-color-disabled' : 'icon-color-delete'">
                                                </svg-icon>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchDefault>
                                            <span class="text-truncate">{{row[column.id]}}</span>
                                        </ng-container>
                                    </td>
                                </ng-container>
                            </tr>
                        </ng-template>
                    </p-table>
                    <div class="guardian-grid-paginator">
                        <app-paginator
                            class="guardian-grid-paginator"
                            [pageIndex]="walletPageIndex"
                            [pageSize]="walletPageSize"
                            [length]="walletCount"
                            (page)="onWalletPage($event)"
                        ></app-paginator>
                    </div>
                </div>
            </ng-container>
            <ng-template #noData>
                <div class="guardian-user-not-data">
                    <svg-icon
                        class="svg-icon-32"
                        src="/assets/images/icons/32/list.svg"
                        svgClass="icon-color-disabled"></svg-icon>
                    <span class="guardian-user-not-data__text-strong">There are no wallets created yet</span>
                    <span class="guardian-user-not-data__text">Please create a new wallet to see the data</span>
                </div>
            </ng-template>
        </div>
    </ng-container>
</ng-template>

<ng-template #registerDID>
    <form
        (ngSubmit)="onSubmit()"
        *ngIf="!isConfirmed && isNewAccount"
        [formGroup]="hederaForm"
        class="finish-setup-form"
    >
        <div *ngIf="!isRestore && step === 'HEDERA'" class="finish-setup-title">Hedera Account</div>
        <div *ngIf="!isRestore && step === 'DID'" class="finish-setup-title">DID Document</div>
        <div *ngIf="!isRestore && step === 'DID_KEYS'" class="finish-setup-title">DID Document signing keys</div>
        <div *ngIf="!isRestore && step === 'VC'" class="finish-setup-title">Standard Registry Details</div>
        <div *ngIf="isRestore" class="finish-setup-title">Restore Data</div>

        <div class="finish-setup-form-container">
            <div class="list">

                <div *ngIf="step === 'HEDERA'" class="list-item">
                    <div class="input-field-container">
                        <label class="form-label" htmlFor="operatorId">
                            * OPERATOR ID (Hedera Account):
                        </label>
                        <input
                            formControlName="hederaAccountId"
                            id="operatorId"
                            pInputText
                            placeholder="0.0.1548173"
                            type="text"
                        />
                    </div>
                    <div class="input-field-container">
                        <label class="form-label" htmlFor="operatorKey">
                            * OPERATOR KEY (Hedera Account Private Key):
                        </label>
                        <input
                            formControlName="hederaAccountKey"
                            id="operatorKey"
                            pInputText
                            placeholder="302e020100300506032b657004220420e..."
                            type="text"
                        />
                    </div>
                    <div class="input-field-container">
                        <p-checkbox
                            [binary]="true"
                            formControlName="useFireblocksSigning"
                            inputId="useFireblocksSigning"
                            label="Use fireblocks signing"
                        ></p-checkbox>
                    </div>
                    <div [ngClass]="{'hide-block': hederaForm.get('useFireblocksSigning')?.value === false}">
                        <div class="input-field-container">
                            <label class="form-label" htmlFor="fireBlocksVaultId">
                                * Fireblocks Vault ID:
                            </label>
                            <input
                                formControlName="fireBlocksVaultId"
                                id="fireBlocksVaultId"
                                placeholder="0"
                                pInputText
                                type="text"
                            />
                        </div>
                        <div class="input-field-container">
                            <label class="form-label" htmlFor="fireBlocksAssetId">
                                * Fireblocks Asset ID:
                            </label>
                            <input
                                formControlName="fireBlocksAssetId"
                                id="fireBlocksAssetId"
                                pInputText
                                placeholder="ASSET_NAME"
                                type="text"
                            />
                        </div>
                        <div class="input-field-container">
                            <label class="form-label" htmlFor="fireBlocksApiKey">
                                * Fireblocks API Key:
                            </label>
                            <input
                                formControlName="fireBlocksApiKey"
                                id="fireBlocksApiKey"
                                autocomplete="off"
                                pInputText
                                placeholder="00000000-0000-0000-0000-000000000000"
                                type="text"
                            />
                        </div>
                        <div class="input-field-container">
                            <label class="form-label" htmlFor="fireBlocksPrivateiKey">
                                * Fireblocks Private Key:
                            </label>
                            <textarea
                                formControlName="fireBlocksPrivateiKey"
                                id="fireBlocksPrivateiKey"
                                autocomplete="off"
                                pInputText
                                placeholder="-----BEGIN PRIVATE KEY----- ..."
                                type="text"
                            ></textarea>
                        </div>
                    </div>
                </div>

                <div *ngIf="step === 'RESTORE'" class="list-item">
                    <div class="topic-id-field">
                        <div class="group-body">
                            <div class="form-group example-full-width">
                                <label for="topicIdDropdown" class="form-label">Topic ID: </label>
                                <p-dropdown
                                    id="topicIdDropdown"
                                    [options]="userTopics"
                                    [formControl]="selectedTokenId"
                                    optionLabel="topicId"
                                    optionValue="topicId"
                                    [appendTo]="'body'"
                                    placeholder="Select a Topic ID"
                                    class="full-width">
                                    <ng-template let-topic pTemplate="item">
                                        <div class="topic-item">
                                            <span>{{ topic.topicId }}</span>
                                            <span>
                                                <hedera-explorer [params]="topic.topicId" type="topics">
                                                    {{ topic.date }}
                                                </hedera-explorer>
                                            </span>
                                        </div>
                                    </ng-template>
                                </p-dropdown>
                            </div>
                            <div class="list-button">
                                <p-button
                                    (click)="getAllUserTopics($event)"
                                    [disabled]="!hederaForm.valid"
                                    class="generate-btn"
                                    label="Load topics"
                                    [outlined]=true
                                >
                                    <i class="pi pi-replay"></i>
                                </p-button>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="step === 'DID'" class="list-item">
                    <div>
                        <p-radioButton
                            name="didType"
                            [value]="false"
                            [formControl]="didDocumentType"
                            class="boolean-option">
                        </p-radioButton>
                        <label>Generate new DID document.</label>
                    </div>
                    <div>
                        <p-radioButton
                            name="didType"
                            [value]="true"
                            [formControl]="didDocumentType"
                            class="boolean-option">
                        </p-radioButton>
                        <label>Custom DID document.</label>
                    </div>
                    <div class="form-group example-full-width" [attr.active-field]="didDocumentType.value">
                        <textarea
                            pInputTextarea
                            id="didDocumentTextarea"
                            [formControl]="didDocumentForm"
                            style="height: 150px; width: 100%;"
                            class="full-width"
                            placeholder="DID Document: *"
                        >
                        </textarea>
                        <small *ngIf="didDocumentForm.hasError('incorrect')" class="p-error">
                            Invalid DID Document.
                        </small>
                        <small *ngIf="didDocumentForm.hasError('exists')" class="p-error">
                            DID Document already exists.
                        </small>
                    </div>
                </div>

                <div *ngIf="step === 'DID_KEYS'" class="list-item">
                    <div *ngFor="let item of didKeys" class="group-container">
                        <label [htmlFor]="item.name" class="form-label">
                            {{ item.name }}:
                        </label>
                        <div class="form-group example-full-width">
                            <label for="methodDropdown" class="form-label">* Method:</label>
                            <p-dropdown
                                id="methodDropdown"
                                [options]="item.keyNames"
                                [formControl]="item.keyNameControl"
                                optionLabel="name"
                                optionValue="id"
                                [appendTo]="'body'"
                                placeholder="Select a method"
                                class="full-width">
                            </p-dropdown>
                        </div>
                        <div class="form-group example-full-width">
                            <label for="keyInput" class="form-label">* Key:</label>
                            <input
                                pInputText
                                id="keyInput"
                                [formControl]="item.keyValueControl"
                                placeholder="FRs4qVjqvP9Dh..."
                                class="full-width">
                            <small *ngIf="item.keyValueControl.hasError('incorrect')" class="p-error">
                                Invalid DID Key
                            </small>
                        </div>
                    </div>
                </div>

                <div *ngIf="step === 'VC'" class="list-item">
                    <app-schema-form-root
                        [isFormForFinishSetup]="true"
                        [private-fields]="hidePrivateFields"
                        [schema]="schema"
                        [showButtons]="false"
                        (change)="onChangeForm()"
                        (form)="initForm($event)"
                    >
                    </app-schema-form-root>
                </div>
            </div>

            <div *ngIf="step === 'HEDERA'" class="action-btns">
                <p-button
                    (click)="randomKey()"
                    class="generate-btn"
                    label="Generate"
                    [outlined]=true
                >
                </p-button>
                <p-button
                    (click)="onRestoreStep()"
                    [disabled]="!hederaForm.valid"
                    class="generate-btn"
                    label="Restore data"
                    [outlined]=true
                >
                    <i class="pi pi-replay"></i>
                </p-button>
                <p-button
                    (click)="onNextStep()"
                    [disabled]="!hederaForm.valid"
                    class="next-btn"
                    label="Next"
                >
                </p-button>
            </div>

            <div *ngIf="step === 'DID'" class="action-btns">
                <div class="row-btns">
                    <p-button
                        (click)="onPrevStep()"
                        class="generate-btn"
                        label="Prev"
                        [outlined]=true
                    >
                    </p-button>
                    <p-button
                        *ngIf="didDocumentType.value"
                        (click)="parseDidDocument()"
                        [disabled]="!didDocumentForm.valid"
                        class="next-btn"
                        label="Next"
                    >
                    </p-button>
                    <p-button
                        *ngIf="!didDocumentType.value"
                        (click)="onNextStep()"
                        class="next-btn"
                        label="Next"
                    >
                    </p-button>
                </div>
            </div>

            <div *ngIf="step === 'DID_KEYS'" class="action-btns">
                <div class="row-btns">
                    <p-button
                        (click)="onPrevStep()"
                        class="generate-btn"
                        label="Prev"
                        [outlined]=true
                    >
                    </p-button>
                    <p-button
                        (click)="parseDidKeys()"
                        [disabled]="!didKeysControl.valid"
                        class="next-btn"
                        label="Next"
                    >
                    </p-button>
                </div>
            </div>

            <div *ngIf="step === 'RESTORE'" class="action-btns">
                <p-button
                    (click)="onPrevStep()"
                    class="generate-btn"
                    label="Prev"
                    [outlined]=true
                >
                </p-button>
                <p-button
                    (click)="onRestore()"
                    [disabled]="!selectedTokenId.valid"
                    class="next-btn"
                    label="Proceed"
                >
                </p-button>
            </div>

            <div *ngIf="step === 'VC'" class="action-btns">
                <div class="row-btns">
                    <p-button
                        (click)="onPrevStep()"
                        class="generate-btn"
                        label="Prev"
                        [outlined]=true
                    >
                    </p-button>
                    <p-button
                        [disabled]="!validVC"
                        class="connect-btn"
                        label="Connect"
                        type="submit"
                    >
                    </p-button>
                </div>
            </div>
        </div>

    </form>

    <div *ngIf="!isConfirmed && !isNewAccount && !isFailed" class="loading">
        <div class="progress">
            <span>Finishing Setup</span>
            <p-progressBar [value]="progress" mode="determinate"></p-progressBar>
        </div>
    </div>

    <div *ngIf="!isConfirmed && isFailed" class="error-list">
        <p>An error occurred while creating the document.</p>
        <p>Please try again later.</p>
        <button
            (click)="retry()"
            color="primary"
            mat-raised-button
            type="button"
        >
            Retry
        </button>
    </div>

    <div *ngIf="errorLoadSchema" class="error-schema">
        <p>Failed to load system schemas.</p>
    </div>
</ng-template>

<ng-template #taskExecution>
    <async-progress
        (completed)="onAsyncCompleted()"
        (error)="onAsyncError($event)"
        *ngIf="loading && taskId"
        [taskId]="taskId"
    ></async-progress>
</ng-template>
