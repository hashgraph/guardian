<ng-container [ngTemplateOutlet]="!tokenId ? tokensTable : usingTokens"></ng-container>

<ng-template #tokensTable>
    <div class="guardian-page">
        <div *ngIf="loading" class="guardian-loading">
            <div class="guardian-loading-image"></div>
        </div>

        <div *ngIf="!isConfirmed" class="guardian-user-not-registered">
            Before starting work you need to get DID
            <a [routerLink]="['/profile']">here</a>
        </div>

        <div *ngIf="!loading" class="guardian-user-page-header">
            <span>List of Tokens</span>
        </div>

        <div *ngIf="!loading" class="guardian-user-page-toolbar">
            <div class="guardian-user-page-filters">
                <div *ngIf="policies" class="dropdown-block">
                    <p-dropdown 
                        (onChange)="onFilter()" 
                        [appendTo]="'body'" 
                        [(ngModel)]="policyDropdownItem" 
                        [options]="policies!"
                    >
                        <ng-template pTemplate="selectedItem">
                            <div *ngIf="policyDropdownItem">
                                <span class="dropdown-label">Policy</span>
                                <span class="dropdown-item">{{ policyDropdownItem.name }}</span></div>
                        </ng-template>
                        <ng-template let-policy pTemplate="item">
                            <div class="dropdown-item">
                                {{ policy.name + (policy.id !== -1 ? ' (' + policy.id + ')' : '') }}
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
            </div>
            <div class="guardian-user-page-buttons">
                <button
                    *ngIf="user.TOKENS_TOKEN_CREATE"
                    (click)="newToken()"
                    class="guardian-button guardian-button-primary">
                    <div class="guardian-button-icon">
                        <svg-icon class="icon-btn svg-icon"
                            src="/assets/images/icons/add.svg"
                            svgClass="icon-color-secondary">
                        </svg-icon>
                    </div>
                    <div class="guardian-button-label">Create token</div>
                </button>
            </div>
        </div>

        <div *ngIf="!loading" class="guardian-user-page-grid">
            <ng-container *ngIf="tokens && tokens.length > 0; else noData">
                <div class="grid-table-container">
                    <p-table
                        class="grid-table"
                        [value]="tokens"
                        [scrollable]="true"
                    >
                        <ng-template pTemplate="header">
                            <tr class="grid-table-header">
                                <ng-container *ngFor="let column of columns">
                                    <th
                                        *ngIf="!column.canDisplay || column.canDisplay()"
                                        class="header-cell-{{column.type}} col-{{column.size}}"
                                        [ngSwitch]="column.id"
                                    >
                                        <ng-container *ngSwitchCase="'select'">
                                            <p-checkbox
                                                (onChange)="onSelectAllItems($event)"
                                                [disabled]="isAnyDeleteDisabled()"
                                                [ngModel]="isAllSelected"
                                                [binary]="true"
                                            >
                                            </p-checkbox>
                                        </ng-container>
                                        <ng-container *ngSwitchDefault>
                                            {{column.title}}
                                        </ng-container>
                                    </th>
                                </ng-container>
                            </tr>
                        </ng-template>
                        <ng-template let-row pTemplate="body">
                            <tr class="guardian-grid-row">
                                <ng-container *ngFor="let column of columns">
                                    <td
                                        *ngIf="!column.canDisplay || column.canDisplay()"
                                        class="row-cell-{{column.type}} col-{{column.size}}"
                                        pTooltip="{{row[column.id]}}"
                                        [tooltipDisabled]="!column.tooltip"
                                        tooltipPosition="top"
                                        [showDelay]="1000"
                                        [ngSwitch]="column.id"
                                    >
                                        <ng-container *ngSwitchCase="'select'">
                                                <p-checkbox
                                                    (onChange)="onSelectItem(row)"
                                                    [disabled]="isDeleteDisabled(row)"
                                                    [ngModel]="isSelected(row)"
                                                    [binary]="true"
                                                >
                                                </p-checkbox>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'id'">
                                            <hedera-explorer 
                                                *ngIf="!row.draftToken else draftToken" 
                                                [params]="row.tokenId" 
                                                type="tokens"
                                            >{{ row.tokenId }}</hedera-explorer>
                                            <ng-template #draftToken>Draft Token</ng-template>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'name'">
                                            <span class="text-truncate">{{row.tokenName}}</span>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'symbol'">
                                            <span class="text-truncate">{{row.tokenSymbol}}</span>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'policies'">
                                            <span class="text-truncate">{{row.policies?.join(', ')}}</span>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'tags'">
                                            <tags-explorer
                                                    *ngIf="user.TAGS_TAG_READ"
                                                    [user]="user"
                                                    [data]="row._tags"
                                                    [entity]="tagEntity"
                                                    [owner]="owner"
                                                    [schemas]="tagSchemas"
                                                    [service]="tagsService"
                                                    [target]="row.id"></tags-explorer>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'options'">
                                            <div
                                                *ngIf="user.TOKENS_TOKEN_MANAGE"
                                                [attr.disabled]="row.draftToken"
                                                class="guardian-icon-button big"
                                                (click)="!row.draftToken ? goToUsingTokens(row) : null"
                                            >
                                                <svg-icon
                                                    class="icon-btn"
                                                    src="/assets/images/icons/group.svg"
                                                    [svgClass]="!row.draftToken ? 'icon-color-primary': 'icon-color-disabled'">
                                                </svg-icon>
                                            </div>
                                            <div
                                                *ngIf="user.TOKENS_TOKEN_UPDATE"
                                                [attr.disabled]="!row.enableAdmin"
                                                class="guardian-icon-button big"
                                                (click)="row.enableAdmin ? openEditDialog(row) : null"
                                            >
                                                <svg-icon
                                                    class="icon-btn"
                                                    src="/assets/images/icons/edit.svg"
                                                    [svgClass]="row.enableAdmin ? 'icon-color-primary': 'icon-color-disabled'">
                                                </svg-icon>
                                            </div>
                                            <div
                                                *ngIf="user.TOKENS_TOKEN_DELETE"
                                                [attr.disabled]="!row.canDelete"
                                                class="guardian-icon-button big"
                                                (click)="row.canDelete ? questToDeleteToken(row) : null"
                                            >
                                                <svg-icon
                                                    class="icon-btn"
                                                    src="/assets/images/icons/delete.svg"
                                                    [svgClass]="row.canDelete ? 'icon-color-delete': 'icon-color-disabled'">
                                                </svg-icon>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchDefault>
                                            <span class="text-truncate">{{row[column.id]}}</span>
                                        </ng-container>
                                    </td>
                                </ng-container>
                            </tr>
                        </ng-template>
                    </p-table>
                    <div class="guardian-grid-paginator">
                        <app-paginator
                            class="guardian-grid-paginator"
                            [pageIndex]="pageIndex"
                            [pageSize]="pageSize"
                            [length]="tokensCount"
                            (page)="onPage($event)"
                        ></app-paginator>
                    </div>
                </div>
            </ng-container>
            <ng-template #noData>
                <div class="guardian-user-not-data">
                    <svg-icon
                        class="svg-icon-32"
                        src="/assets/images/icons/32/list.svg"
                        svgClass="icon-color-disabled"></svg-icon>
                    <span class="guardian-user-not-data__text-strong">There are no tokens created yet</span>
                    <span class="guardian-user-not-data__text">Please create a new token to see the data</span>
                </div>
            </ng-template>
        </div>
    </div>
</ng-template>

<ng-template #usingTokens>
    <div class="guardian-page">
        <div class="back-button">
            <button 
                (click)="goToTokensPage()" 
                class="guardian-button guardian-button-secondary">
                <div class="guardian-button-icon">
                    <svg-icon class="icon-btn svg-icon"
                        src="/assets/images/icons/left-arrow.svg"
                        svgClass="icon-color-primary">
                    </svg-icon>
                </div>
                <div class="guardian-button-label">Back to List of Tokens</div>
            </button>
        </div>

        <div *ngIf="loading" class="guardian-loading">
            <div class="guardian-loading-image"></div>
        </div>

        <div *ngIf="!isConfirmed" class="guardian-user-not-registered">
            Before starting work you need to get DID
            <a [routerLink]="['/profile']">here</a>
        </div>

        <div *ngIf="!loading" class="guardian-user-page-header">
            <span>Token Users</span>
            <div class="token-id">
                <span class="token-id-name">Token ID:</span>
                 <span class="token-id-value">{{ tokenId }}</span>
            </div>
        </div>

        <div *ngIf="!loading" class="guardian-user-page-grid">
            <ng-container *ngIf="users && users.length > 0; else noData">
                <div class="grid-table-container">
                    <p-table
                        class="grid-table"
                        [value]="users"
                        [scrollable]="true"
                    >
                        <ng-template pTemplate="header">
                            <tr class="guardian-grid-header">
                                <ng-container *ngFor="let column of usersColumns">
                                    <th
                                        *ngIf="!column.canDisplay || column.canDisplay()"
                                        class="header-cell-{{column.type}} col-{{column.size}}"
                                        >{{column.title}}</th>
                                </ng-container>
                            </tr>
                        </ng-template>
                        <ng-template let-row pTemplate="body">
                            <tr class="guardian-grid-row">
                                <ng-container *ngFor="let column of usersColumns">
                                    <td
                                        *ngIf="!column.canDisplay || column.canDisplay()"
                                        class="row-cell-{{column.type}} col-{{column.size}}"
                                        pTooltip="{{row[column.id]}}"
                                        [tooltipDisabled]="!column.tooltip"
                                        tooltipPosition="top"
                                        [showDelay]="1000"
                                        [ngSwitch]="column.id"
                                    >
                                        <ng-container *ngSwitchCase="'username'">
                                            <span class="text-truncate">{{row.username}}</span>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'id'">
                                            <hedera-explorer [params]="row.relayerAccountId || ''" type="accounts">
                                                {{ row.relayerAccountId }}
                                            </hedera-explorer>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'name'">
                                            <span class="text-truncate">{{row.relayerAccountName || ''}}</span>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'balance'"> 
                                            <div *ngIf="row.loading" class="options-container">
                                                <div class="loading-placeholder balance-size"></div>
                                            </div>
                                            <div *ngIf="!row.loading && row.associated === 'Yes'" class="options-container">
                                                <div class="user-balance balance-size">{{ row.balance }}</div>
                                            </div>
                                            <div *ngIf="!row.loading && row.associated === 'No'" class="options-container">
                                                No associated
                                            </div>
                                            <div *ngIf="!row.loading && row.associated === 'n/a'" class="options-container">
                                                No Data
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'freeze'">
                                            <div *ngIf="row.loading" class="options-container">
                                                <div class="loading-placeholder freeze-size"></div>
                                            </div>
                                            <div *ngIf="!row.loading" class="options-container">
                                                <button
                                                    (click)="freeze(row, row.frozen === 'No')"
                                                    [disabled]="!row.enableFreeze || row.frozen === 'n/a' || row.associated === 'No' || row.associated === 'n/a'"
                                                    class="guardian-button guardian-button-secondary freeze-size"
                                                >
                                                    <div 
                                                        *ngIf="row.frozen !== 'Yes'"
                                                        class="guardian-button-label"
                                                    >Freeze</div>
                                                    <div 
                                                        *ngIf="row.frozen === 'Yes'"
                                                        class="guardian-button-label"
                                                    >Unfreeze</div>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'kyc'"> 
                                            <div *ngIf="row.loading" class="options-container">
                                                <div class="loading-placeholder kyc-size"></div>
                                            </div>
                                            <div *ngIf="!row.loading" class="options-container">
                                                <button
                                                    (click)="kyc(row, row.kyc === 'No')"
                                                    [disabled]="!row.enableKYC || row.kyc === 'n/a' || row.associated === 'No' || row.associated === 'n/a'"
                                                    class="guardian-button guardian-button-secondary kyc-size"
                                                >
                                                    <div 
                                                        *ngIf="row.kyc !== 'Yes'"
                                                        class="guardian-button-label"
                                                    >Grant KYC</div>
                                                    <div 
                                                        *ngIf="row.kyc === 'Yes'"
                                                        class="guardian-button-label"
                                                    >Revoke KYC</div>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngSwitchCase="'refresh'">
                                            <div
                                                [attr.disabled]="row.loading"
                                                class="guardian-icon-button big"
                                                (click)="!row.loading ? refresh(row) : null"
                                            >
                                                <svg-icon
                                                    class="icon-btn"
                                                    src="/assets/images/icons/refresh-2.svg"
                                                    [svgClass]="!row.loading ? 'icon-color-primary': 'icon-color-disabled'">
                                                </svg-icon>
                                            </div>
                                        </ng-container>    
                                        <ng-container *ngSwitchDefault>
                                            <span class="text-truncate">{{row[column.id]}}</span>
                                        </ng-container>
                                    </td>
                                </ng-container>
                            </tr>
                        </ng-template>
                    </p-table>
                    <div class="guardian-grid-paginator">
                        <app-paginator
                            class="guardian-grid-paginator"
                            [pageIndex]="userPageIndex"
                            [pageSize]="userPageSize"
                            [length]="userPageCount"
                            (page)="onUserPage($event)"
                        ></app-paginator>
                    </div>
                </div>
            </ng-container>
            <ng-template #noData>
                <div class="guardian-user-not-data">
                    <svg-icon
                        class="svg-icon-32"
                        src="/assets/images/icons/32/list.svg"
                        svgClass="icon-color-disabled"></svg-icon>
                    <span class="guardian-user-not-data__text-strong">There are no accounts created yet</span>
                    <span class="guardian-user-not-data__text">Please create a new account to see the data</span>
                </div>
            </ng-template>
        </div>
    </div>
</ng-template>

<ng-template #preloader>
    <div class="preloader-image"></div>
</ng-template>

<div *ngIf="loading && !taskId" class="loading">
    <div class="preloader-image preloader-image-l-size"></div>
</div>

<div *ngIf="isAnyItemSelected()" class="options-footer-container">
    <div class="options-footer">
        <div class="selected-info-block">
            <span class="selected-info">{{ selectedItems.length | pluralize: 'token' : 'tokens'}} selected</span>
            <p-button
                (click)="onClearSelection()"
                class="secondary-btn"
                [outlined]="true"
            >
                Clear selection
            </p-button>
        </div>
        <div>
            <p-button
                (click)="onDeleteItems()"
                severity="danger"
                label="Delete selected"
                type="button"></p-button>
        </div>
    </div>
</div>

<async-progress *ngIf="loading && taskId" [taskId]="taskId"
                (completed)="onAsyncCompleted()" (error)="onAsyncError($event)"></async-progress>
